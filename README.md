# gif-displayer-dataGenTool
A tool for converting video to hex data and uploading hex data to flash chip.

# 动图显示器：数据处理

> 该仓库是[动图显示器](https://github.com/TongLeen/gif-displayer)的一部分

本程序用以实现对视频文件的处理，生成所需的二进制文件，并提供将其上传到FLASH芯片的方法。

# 使用

## 依赖

本程序有三个功能：
- 视频编码
- 视频解码
- 二进制文件上传

视频的编解码依赖于：
- numpy
- opencv

二进制文件上传依赖于：
- CH341 驱动程序

## 使用方法

`python main.py (-e | -d | -u) -f PATH [-o PATH] [-p PORT]`

其中`-e` `-d` `-u` 分别对应于视频编码，视频解码和二进制文件上传；

`-f` 为指定文件作为输入，后接文件路径；

`-o` 为指定输出文件，后接文件路径，可省略；

`-p` 为指定上传的端口，当选择功能`-u`时必须指定该参数，可选的值为`[0 1 2]`，对应于CH341芯片上三个使能管脚；

**示例：**

`python main.py -e -f video.mp4 -o data.hex`

将`video.mp4`文件编码为`data.hex`文件

`python main.py -d -f data.hex -o video_decoded.mp4`

将`data.hex`解码为视频`video_decoded.mp4`

`python main.py -u -f data.hex -p 0`

将`data.hex`写入到连接到引脚`D0`的FLASH芯片

---

# 实现原理

## 视频文件的处理和编码

本项目中使用的显示屏驱动芯片为ST7789，驱动一个240x240，16bit的LCD显示屏。
对于主控MCU——STM32F103来讲，如此庞大的视频数据，没办法保存到内部FALSH当中，也没法实时运算。
因此，唯一的办法就是将视频直接编码成最终显示屏需要的格式，存储在外部的FLASH芯片当中，
直接将FLASH芯片中的数据搬到显示屏上，以实现视频的播放。

考虑到W25Q64芯片的容量为64Mbit，即8MiB，每一帧画面需要 240x240x2=115200 Byte，确定一共保存66帧图像，这大概相当于3秒的视频。
~~(别问为什么是66，随便选的)~~
使用`opencv`读取视频文件，原始的视频文件进行抽帧，改变分辨率，得到240x240，66帧的视频。

ST7789支持多种色彩格式，这里使用RGB565的格式。由于使用`opencv`读取的每一帧画面为BGR888的格式，因此需要对每个像素点进行编码。
这里使用最简单的方式，将每个像素点的各个通道直接舍去低位，拼接成16bit的RGB565像素点。
|编码后|15:11|10:5|4:0|
|---|---|---|---|
|编码前|R[7:3]|G[7:2]|B[7:3]|

将编码后得到数据转为字节流，写入到文件中。转换顺序与显示屏扫描的方向有关，不同的转换顺序会形成不同方向的图像。

## 二进制文件的解码

这部分对于设备来讲并不是必须的。该程序用来预览二进制文件播放后的效果。

将上述编码过程反方向进行，即可得到解码后的视频文件。**注意通道的顺序为BGR**

## 二进制文件上传

使用CH341芯片，将USB接口转为SPI总线。通过控制该SPI总线，实现对W25Q64芯片的读写，具体读写方法参考CH341芯片和W25Q64芯片的用户手册。

将数据写入后，再将数据读出，检查写入的数据是否与源数据相同，避免写入时出错。

---


